<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NOG Deck Studio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
</head>
<body class="min-h-screen bg-slate-100 text-slate-900">
  <main id="app" class="max-w-6xl mx-auto p-4 md:p-6 space-y-4">
    <section id="hero" class="rounded-3xl bg-gradient-to-br from-slate-900 via-slate-800 to-cyan-900 text-white p-6 shadow-xl">
      <p class="text-xs uppercase tracking-[0.2em] text-cyan-300">NOG Deck Studio</p>
      <h1 class="text-3xl md:text-4xl font-semibold mt-2">Simple deck converter & creator</h1>
      <p class="text-slate-200 mt-2">Upload your old PowerPoint and generate a cleaner, creative version safely inside NOG colour rules.</p>
      <div class="mt-4 inline-flex items-center gap-2 rounded-full bg-white/10 px-3 py-1 text-sm">
        <span class="h-2 w-2 rounded-full bg-emerald-400"></span>
        <span id="statusText">Choose a connection option below</span>
      </div>
    </section>

    <section id="quickConnect" class="bg-white rounded-2xl p-5 shadow space-y-3">
      <h2 class="text-xl font-semibold">Quick Connect (one click)</h2>
      <p class="text-sm text-slate-600">Use one of these buttons so you do not need to manually type URLs.</p>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <button id="btnRecommended" class="px-4 py-3 rounded-xl bg-slate-900 text-white">Use recommended cloud API</button>
        <button id="btnLocal" class="px-4 py-3 rounded-xl bg-cyan-700 text-white">Use local API (localhost)</button>
        <button id="btnHealth" class="px-4 py-3 rounded-xl bg-emerald-700 text-white">Check connection</button>
      </div>
      <details class="rounded-xl border border-slate-200 p-3">
        <summary class="cursor-pointer font-medium">Advanced: custom API URL</summary>
        <div class="mt-2 flex flex-col md:flex-row gap-2">
          <input id="apiBase" class="flex-1 border rounded-lg px-3 py-2" placeholder="https://.../api" />
          <button id="btnSaveCustom" class="px-4 py-2 rounded-lg bg-slate-800 text-white">Save custom URL</button>
        </div>
      </details>
      <p id="health" class="text-sm text-slate-700"></p>
    </section>

    <section class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div id="creative" class="bg-white rounded-2xl p-5 shadow space-y-3">
        <div>
          <h2 class="text-2xl font-semibold">1) Create new creative deck</h2>
          <p class="text-sm text-slate-600">Recommended flow: upload old PPTX as reference and click Generate.</p>
        </div>
        <label class="text-sm font-medium">Category Group</label>
        <select id="category" class="w-full border rounded-lg px-3 py-2">
          <option>All Incident Fires</option>
        </select>
        <label class="text-sm font-medium">Creativity</label>
        <select id="creativity" class="w-full border rounded-lg px-3 py-2"><option>Low</option><option selected>Med</option><option>High</option></select>
        <label class="text-sm font-medium">Reference old PPTX</label>
        <input id="creativeOld" type="file" accept=".pptx" class="block w-full text-sm" />
        <details class="rounded-xl border border-slate-200 p-3">
          <summary class="cursor-pointer text-sm font-medium">Optional: use outline text instead of a PPTX</summary>
          <textarea id="outline" rows="5" placeholder="Paste outline text here" class="w-full border rounded-lg px-3 py-2 mt-2"></textarea>
        </details>
        <button id="btnGenerateCreative" class="w-full px-4 py-3 rounded-xl bg-emerald-700 text-white font-medium">Generate Creative Deck</button>
      </div>

      <div id="template" class="bg-white rounded-2xl p-5 shadow space-y-3">
        <div>
          <h2 class="text-2xl font-semibold">2) Template-Locked conversion</h2>
          <p class="text-sm text-slate-600">Use this when you must preserve an existing template style.</p>
        </div>
        <label class="text-sm font-medium">Old PPTX</label>
        <input id="oldPptx" type="file" accept=".pptx" class="block w-full text-sm" />
        <label class="text-sm font-medium">Template PPTX</label>
        <input id="tplPptx" type="file" accept=".pptx" class="block w-full text-sm" />
        <button id="btnConvertTemplate" class="w-full px-4 py-3 rounded-xl bg-cyan-700 text-white font-medium">Convert Using Template</button>
      </div>
    </section>

    <section id="jobsCard" class="bg-white rounded-2xl p-5 shadow">
      <div class="flex items-center justify-between gap-2">
        <h2 class="text-2xl font-semibold">Jobs</h2>
        <button id="btnRefreshJobs" class="px-4 py-2 rounded-lg bg-slate-800 text-white">Refresh</button>
      </div>
      <div id="jobs" class="space-y-2 mt-3"></div>
    </section>

    <details id="logCard" class="bg-white rounded-2xl p-5 shadow">
      <summary class="cursor-pointer font-semibold">Technical log</summary>
      <pre id="log" class="bg-slate-950 text-slate-100 text-xs p-3 rounded-lg mt-3 overflow-auto"></pre>
    </details>
  </main>

<script>
(() => {
  const app = document.getElementById('app')
  const $ = (id) => app.querySelector('#' + id)
  const DEFAULT_API = 'https://nog-api.onrender.com/api'
  const LOCAL_API = 'http://localhost:8000/api'

  const getApi = () => (localStorage.getItem('nog_api_base') || '').replace(/\/$/, '')
  const setApi = (url) => {
    const clean = url.replace(/\/$/, '')
    localStorage.setItem('nog_api_base', clean)
    $('apiBase').value = clean
    $('statusText').textContent = `Connected target: ${clean}`
  }

  const log = (msg) => {
    $('log').textContent = `${new Date().toISOString()} ${msg}\n` + $('log').textContent
  }

  const ensureApi = () => {
    if (getApi()) return true
    $('statusText').textContent = 'Please click a Quick Connect button first.'
    log('No API configured')
    return false
  }

  const loadCategories = async () => {
    if (!ensureApi()) return
    try {
      const r = await fetch(`${getApi()}/categories`)
      const d = await r.json()
      const options = (d.groups || []).map((g) => `<option>${g.name}</option>`).join('')
      $('category').innerHTML = options || '<option>All Incident Fires</option>'
    } catch (e) {
      log('Categories load failed: ' + e.message)
    }
  }

  const checkHealth = async () => {
    if (!ensureApi()) return
    try {
      const r = await fetch(`${getApi()}/health`)
      const d = await r.json()
      $('health').textContent = `✅ API healthy: ${JSON.stringify(d)}`
    } catch (e) {
      $('health').textContent = `❌ Health check failed: ${e.message}`
    }
  }

  const convertTemplateLocked = async () => {
    if (!ensureApi()) return
    if (!$('oldPptx').files[0] || !$('tplPptx').files[0]) return log('Pick both old + template PPTX files first')
    try {
      const fd = new FormData()
      fd.append('old_pptx', $('oldPptx').files[0])
      fd.append('template_pptx', $('tplPptx').files[0])
      const r = await fetch(`${getApi()}/convert/template-locked`, { method: 'POST', body: fd })
      const d = await r.json()
      log('Template-Locked job created: ' + JSON.stringify(d))
      refreshJobs()
    } catch (e) {
      log('Template-Locked failed: ' + e.message)
    }
  }

  const convertCreative = async () => {
    if (!ensureApi()) return
    const hasPptx = Boolean($('creativeOld').files[0])
    const outline = $('outline').value.trim()
    if (!hasPptx && !outline) return log('Upload old PPTX or enter outline text')
    try {
      const fd = new FormData()
      fd.append('category_group', $('category').value)
      fd.append('creativity', $('creativity').value)
      if (hasPptx) fd.append('old_pptx', $('creativeOld').files[0])
      else fd.append('outline_text', outline)
      const r = await fetch(`${getApi()}/convert/creative`, { method: 'POST', body: fd })
      const d = await r.json()
      log('Creative job created: ' + JSON.stringify(d))
      refreshJobs()
    } catch (e) {
      log('Creative generate failed: ' + e.message)
    }
  }

  const refreshJobs = async () => {
    if (!ensureApi()) return
    try {
      const r = await fetch(`${getApi()}/jobs`)
      const jobs = await r.json()
      $('jobs').innerHTML = jobs.map((j) => `<div class='p-3 border border-slate-200 rounded-xl flex items-center justify-between gap-2'>
        <div>
          <div class='font-medium'>${j.job_id}</div>
          <div class='text-sm text-slate-600'>${j.status} (${j.progress || 0}%)</div>
        </div>
        <div class='flex items-center gap-3 text-sm'>
          <a class='text-blue-700 underline' href='${getApi()}/jobs/${j.job_id}/download' target='_blank'>Download</a>
          <button class='text-slate-700 spec-btn' data-id='${j.job_id}'>Spec</button>
          <button class='text-red-700 del-btn' data-id='${j.job_id}'>Delete</button>
        </div>
      </div>`).join('') || `<p class='text-sm text-slate-500'>No jobs yet.</p>`

      app.querySelectorAll('.del-btn').forEach((btn) => btn.addEventListener('click', async (e) => {
        const id = e.currentTarget.getAttribute('data-id')
        await fetch(`${getApi()}/jobs/${id}`, { method: 'DELETE' })
        refreshJobs()
      }))

      app.querySelectorAll('.spec-btn').forEach((btn) => btn.addEventListener('click', async (e) => {
        const id = e.currentTarget.getAttribute('data-id')
        const res = await fetch(`${getApi()}/jobs/${id}/spec`)
        log(await res.text())
      }))
    } catch (e) {
      log('Jobs refresh failed: ' + e.message)
    }
  }

  $('btnRecommended').addEventListener('click', () => { setApi(DEFAULT_API); loadCategories(); refreshJobs() })
  $('btnLocal').addEventListener('click', () => { setApi(LOCAL_API); loadCategories(); refreshJobs() })
  $('btnHealth').addEventListener('click', checkHealth)
  $('btnSaveCustom').addEventListener('click', () => {
    const custom = $('apiBase').value.trim()
    if (!custom) return
    setApi(custom)
    loadCategories()
    refreshJobs()
  })
  $('btnGenerateCreative').addEventListener('click', convertCreative)
  $('btnConvertTemplate').addEventListener('click', convertTemplateLocked)
  $('btnRefreshJobs').addEventListener('click', refreshJobs)

  const stored = getApi()
  if (stored) {
    $('apiBase').value = stored
    $('statusText').textContent = `Connected target: ${stored}`
    loadCategories()
    refreshJobs()
  }

  gsap.fromTo(['#hero', '#quickConnect', '#creative', '#template', '#jobsCard', '#logCard'],
    { opacity: 0, y: 16 },
    { opacity: 1, y: 0, duration: 0.45, stagger: 0.06, ease: 'power2.out' })
})()
</script>
</body>
</html>
