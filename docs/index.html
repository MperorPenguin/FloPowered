<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NOG Deck Studio</title>
  <style>
    :root {
      --bg: #f1f5f9;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #475569;
      --primary: #0f172a;
      --cyan: #0e7490;
      --green: #047857;
      --border: #e2e8f0;
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .container { max-width: 1120px; margin: 0 auto; padding: 16px; }
    .stack { display: grid; gap: 14px; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: 0 2px 8px rgba(15,23,42,0.06);
      animation: fadeUp .28s ease both;
    }
    .hero {
      color: white;
      border: none;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0e7490 100%);
      box-shadow: 0 10px 24px rgba(2,6,23,0.24);
    }
    .hero h1 { margin: 6px 0 8px; font-size: 2rem; }
    .muted { color: var(--muted); }
    .pill {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,.14);
      font-size: 0.9rem;
    }
    .dot { width: 8px; height: 8px; border-radius: 999px; background: #34d399; }

    .row { display: grid; gap: 8px; }
    .grid-2 { display: grid; gap: 12px; grid-template-columns: 1fr; }
    .grid-3 { display: grid; gap: 8px; grid-template-columns: 1fr; }
    @media (min-width: 900px) {
      .grid-2 { grid-template-columns: 1fr 1fr; }
      .grid-3 { grid-template-columns: repeat(3,1fr); }
      .container { padding: 24px; }
    }

    label { font-size: .9rem; font-weight: 600; }
    input, select, textarea, button {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #cbd5e1;
      font-size: .95rem;
      padding: 10px 12px;
      font: inherit;
    }
    input, select, textarea { background: #fff; color: #0f172a; }
    textarea { min-height: 120px; resize: vertical; }
    button { cursor: pointer; border: none; color: white; font-weight: 600; }
    .btn-dark { background: var(--primary); }
    .btn-cyan { background: var(--cyan); }
    .btn-green { background: var(--green); }

    .jobs { display: grid; gap: 8px; margin-top: 10px; }
    .job {
      border: 1px solid var(--border); border-radius: 12px; padding: 10px;
      display: flex; align-items: center; justify-content: space-between; gap: 10px;
      flex-wrap: wrap;
    }
    .job-actions { display: flex; align-items: center; gap: 10px; }
    .job-actions button { width: auto; padding: 6px 10px; color: #334155; background: #f8fafc; border: 1px solid #cbd5e1; }
    .job-actions .delete { color: #b91c1c; }
    a.link { color: #1d4ed8; text-decoration: underline; font-size: .9rem; }

    details { border: 1px solid var(--border); border-radius: 12px; padding: 10px; }
    pre {
      background: #020617; color: #e2e8f0; border-radius: 10px;
      padding: 10px; overflow: auto; max-height: 220px;
    }

    .small { font-size: .9rem; }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(8px);} to {opacity:1; transform: translateY(0);} }
  </style>
</head>
<body>
  <main id="app" class="container stack">
    <section class="card hero">
      <p class="small" style="letter-spacing:.14em; text-transform:uppercase; color:#7dd3fc; margin:0;">NOG Deck Studio</p>
      <h1>Simple deck converter & creator</h1>
      <p style="margin:0 0 12px; color:#e2e8f0">Upload your old PowerPoint and generate a cleaner, creative version safely inside NOG colour rules.</p>
      <div class="pill"><span class="dot"></span><span id="statusText">Choose a connection option below</span></div>
    </section>

    <section class="card row">
      <h2 style="margin:0">Quick Connect (one click)</h2>
      <p class="small muted" style="margin:0">Use one of these buttons so you do not need to manually type URLs.</p>
      <div class="grid-3">
        <button id="btnRecommended" class="btn-dark">Use recommended cloud API</button>
        <button id="btnLocal" class="btn-cyan">Use local API (localhost)</button>
        <button id="btnHealth" class="btn-green">Check connection</button>
      </div>
      <details>
        <summary><strong>Advanced: custom API URL</strong></summary>
        <div class="grid-2" style="margin-top:8px;">
          <input id="apiBase" placeholder="https://.../api" />
          <button id="btnSaveCustom" class="btn-dark">Save custom URL</button>
        </div>
      </details>
      <p id="health" class="small" style="margin:0"></p>
    </section>

    <section class="grid-2">
      <div class="card row">
        <h2 style="margin:0">1) Create new creative deck</h2>
        <p class="small muted" style="margin:0">Recommended flow: upload old PPTX as reference and click Generate.</p>
        <label for="category">Category Group</label>
        <select id="category">
          <option>All Incident Fires</option>
        </select>
        <label for="creativity">Creativity</label>
        <select id="creativity">
          <option>Low</option><option selected>Med</option><option>High</option>
        </select>
        <label for="creativeOld">Reference old PPTX</label>
        <input id="creativeOld" type="file" accept=".pptx" />
        <details>
          <summary><strong>Optional: use outline text instead of a PPTX</strong></summary>
          <textarea id="outline" placeholder="Paste outline text here"></textarea>
        </details>
        <button id="btnGenerateCreative" class="btn-green">Generate Creative Deck</button>
      </div>

      <div class="card row">
        <h2 style="margin:0">2) Template-Locked conversion</h2>
        <p class="small muted" style="margin:0">Use this when you must preserve an existing template style.</p>
        <label for="oldPptx">Old PPTX</label>
        <input id="oldPptx" type="file" accept=".pptx" />
        <label for="tplPptx">Template PPTX</label>
        <input id="tplPptx" type="file" accept=".pptx" />
        <button id="btnConvertTemplate" class="btn-cyan">Convert Using Template</button>
      </div>
    </section>

    <section class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;">
        <h2 style="margin:0">Jobs</h2>
        <button id="btnRefreshJobs" class="btn-dark" style="width:auto; padding:8px 12px;">Refresh</button>
      </div>
      <div id="jobs" class="jobs"></div>
    </section>

    <details class="card">
      <summary><strong>Technical log</strong></summary>
      <pre id="log"></pre>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
</head>
<body class="min-h-screen bg-slate-100 text-slate-900">
  <main id="app" class="max-w-6xl mx-auto p-4 md:p-6 space-y-4">
  <main class="max-w-6xl mx-auto p-4 md:p-6 space-y-4">
    <section id="hero" class="rounded-3xl bg-gradient-to-br from-slate-900 via-slate-800 to-cyan-900 text-white p-6 shadow-xl">
      <p class="text-xs uppercase tracking-[0.2em] text-cyan-300">NOG Deck Studio</p>
      <h1 class="text-3xl md:text-4xl font-semibold mt-2">Simple deck converter & creator</h1>
      <p class="text-slate-200 mt-2">Upload your old PowerPoint and generate a cleaner, creative version safely inside NOG colour rules.</p>
      <div class="mt-4 inline-flex items-center gap-2 rounded-full bg-white/10 px-3 py-1 text-sm">
        <span class="h-2 w-2 rounded-full bg-emerald-400"></span>
        <span id="statusText">Choose a connection option below</span>
      </div>
    </section>

    <section id="quickConnect" class="bg-white rounded-2xl p-5 shadow space-y-3">
      <h2 class="text-xl font-semibold">Quick Connect (one click)</h2>
      <p class="text-sm text-slate-600">Use one of these buttons so you do not need to manually type URLs.</p>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <button id="btnRecommended" class="px-4 py-3 rounded-xl bg-slate-900 text-white">Use recommended cloud API</button>
        <button id="btnLocal" class="px-4 py-3 rounded-xl bg-cyan-700 text-white">Use local API (localhost)</button>
        <button id="btnHealth" class="px-4 py-3 rounded-xl bg-emerald-700 text-white">Check connection</button>
      <p class="text-sm text-slate-600">No need to type URLs each time. Pick one option and continue.</p>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <button onclick="setApiPreset('recommended')" class="px-4 py-3 rounded-xl bg-slate-900 text-white">Use recommended cloud API</button>
        <button onclick="setApiPreset('local')" class="px-4 py-3 rounded-xl bg-cyan-700 text-white">Use local API (localhost)</button>
        <button onclick="checkHealth()" class="px-4 py-3 rounded-xl bg-emerald-700 text-white">Check connection</button>
      </div>
      <details class="rounded-xl border border-slate-200 p-3">
        <summary class="cursor-pointer font-medium">Advanced: custom API URL</summary>
        <div class="mt-2 flex flex-col md:flex-row gap-2">
          <input id="apiBase" class="flex-1 border rounded-lg px-3 py-2" placeholder="https://.../api" />
          <button id="btnSaveCustom" class="px-4 py-2 rounded-lg bg-slate-800 text-white">Save custom URL</button>
          <button onclick="saveCustomApi()" class="px-4 py-2 rounded-lg bg-slate-800 text-white">Save custom URL</button>
        </div>
      </details>
      <p id="health" class="text-sm text-slate-700"></p>
    </section>

    <section class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div id="creative" class="bg-white rounded-2xl p-5 shadow space-y-3">
        <div>
          <h2 class="text-2xl font-semibold">1) Create new creative deck</h2>
          <p class="text-sm text-slate-600">Recommended flow: upload old PPTX as reference and click Generate.</p>
        </div>
        <label class="text-sm font-medium">Category Group</label>
        <select id="category" class="w-full border rounded-lg px-3 py-2 bg-white text-slate-900">
          <option>All Incident Fires</option>
        </select>
        <select id="category" class="w-full border rounded-lg px-3 py-2">
          <option>All Incident Fires</option>
        </select>
        <select id="category" class="w-full border rounded-lg px-3 py-2"></select>
        <label class="text-sm font-medium">Creativity</label>
        <select id="creativity" class="w-full border rounded-lg px-3 py-2"><option>Low</option><option selected>Med</option><option>High</option></select>
        <label class="text-sm font-medium">Reference old PPTX</label>
        <input id="creativeOld" type="file" accept=".pptx" class="block w-full text-sm" />
        <details class="rounded-xl border border-slate-200 p-3">
          <summary class="cursor-pointer text-sm font-medium">Optional: use outline text instead of a PPTX</summary>
          <textarea id="outline" rows="5" placeholder="Paste outline text here" class="w-full border rounded-lg px-3 py-2 mt-2"></textarea>
        </details>
        <button id="btnGenerateCreative" class="w-full px-4 py-3 rounded-xl bg-emerald-700 text-white font-medium">Generate Creative Deck</button>
        <button onclick="convertCreative()" class="w-full px-4 py-3 rounded-xl bg-emerald-700 text-white font-medium">Generate Creative Deck</button>
      </div>

      <div id="template" class="bg-white rounded-2xl p-5 shadow space-y-3">
        <div>
          <h2 class="text-2xl font-semibold">2) Template-Locked conversion</h2>
          <p class="text-sm text-slate-600">Use this when you must preserve an existing template style.</p>
        </div>
        <label class="text-sm font-medium">Old PPTX</label>
        <input id="oldPptx" type="file" accept=".pptx" class="block w-full text-sm" />
        <label class="text-sm font-medium">Template PPTX</label>
        <input id="tplPptx" type="file" accept=".pptx" class="block w-full text-sm" />
        <button id="btnConvertTemplate" class="w-full px-4 py-3 rounded-xl bg-cyan-700 text-white font-medium">Convert Using Template</button>
        <button onclick="convertTemplateLocked()" class="w-full px-4 py-3 rounded-xl bg-cyan-700 text-white font-medium">Convert Using Template</button>
  <title>NOG Deck Studio – GitHub Pages UI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
</head>
<body class="bg-slate-100 text-slate-900 min-h-screen">
  <main class="max-w-7xl mx-auto p-6 space-y-5">
    <section id="hero" class="rounded-2xl bg-slate-900 text-white p-6 shadow-lg">
      <p class="text-xs uppercase tracking-[0.2em] text-cyan-300">NOG Deck Studio</p>
      <h1 class="text-4xl font-semibold mt-2">GitHub Pages Control UI</h1>
      <p class="text-slate-300 mt-2">This page controls your deployed API/worker/renderer. Upload old PPTX, generate creative decks, and download results.</p>
    </section>

    <section id="connection" class="bg-white rounded-2xl p-5 shadow">
      <h2 class="text-xl font-semibold">Connection</h2>
      <p class="text-sm text-slate-600 mt-1">Set your deployed API base URL (example: <code>https://nog-api.onrender.com/api</code>).</p>
      <div class="flex gap-2 mt-3">
        <input id="apiBase" class="flex-1 border rounded-lg px-3 py-2" placeholder="https://.../api" />
        <button onclick="saveApi()" class="px-4 py-2 rounded-lg bg-slate-900 text-white">Save API URL</button>
        <button onclick="checkHealth()" class="px-4 py-2 rounded-lg bg-cyan-700 text-white">Check API Health</button>
      </div>
      <div id="health" class="text-sm mt-2 text-slate-700"></div>
    </section>

    <section class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div id="tmpl" class="bg-white rounded-2xl p-5 shadow space-y-3">
        <h2 class="text-2xl font-semibold">Template-Locked Convert</h2>
        <p class="text-sm text-slate-600">Strict conversion mode.</p>
        <input id="oldPptx" type="file" accept=".pptx" class="block w-full text-sm" />
        <input id="tplPptx" type="file" accept=".pptx" class="block w-full text-sm" />
        <button onclick="convertTemplateLocked()" class="px-4 py-2 rounded-lg bg-cyan-700 text-white">Convert</button>
      </div>

      <div id="creative" class="bg-white rounded-2xl p-5 shadow space-y-3">
        <h2 class="text-2xl font-semibold">Creative NOG</h2>
        <select id="category" class="w-full border rounded-lg px-3 py-2"></select>
        <select id="creativity" class="w-full border rounded-lg px-3 py-2"><option>Low</option><option selected>Med</option><option>High</option></select>
        <select id="inputType" onchange="toggleInput()" class="w-full border rounded-lg px-3 py-2"><option value="pptx">Old PPTX (reference)</option><option value="outline">Outline Text</option></select>
        <input id="creativeOld" type="file" accept=".pptx" class="block w-full text-sm" />
        <textarea id="outline" rows="5" placeholder="Outline text" class="w-full border rounded-lg px-3 py-2 hidden"></textarea>
        <button onclick="convertCreative()" class="px-4 py-2 rounded-lg bg-emerald-700 text-white">Generate</button>
      </div>
    </section>

    <section id="jobsCard" class="bg-white rounded-2xl p-5 shadow">
      <div class="flex items-center justify-between gap-2">
        <h2 class="text-2xl font-semibold">Jobs</h2>
        <button id="btnRefreshJobs" class="px-4 py-2 rounded-lg bg-slate-800 text-white">Refresh</button>
        <button onclick="refreshJobs()" class="px-4 py-2 rounded-lg bg-slate-800 text-white">Refresh</button>
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-semibold">Jobs</h2>
        <button onclick="refreshJobs()" class="px-4 py-2 rounded-lg bg-slate-800 text-white">Refresh Jobs</button>
      </div>
      <div id="jobs" class="space-y-2 mt-3"></div>
    </section>

    <details id="logCard" class="bg-white rounded-2xl p-5 shadow">
      <summary class="cursor-pointer font-semibold">Technical log</summary>
      <pre id="log" class="bg-slate-950 text-slate-100 text-xs p-3 rounded-lg mt-3 overflow-auto"></pre>
    </details>
  </main>

<script>
(() => {
  const app = document.getElementById('app')
  const $ = (id) => app.querySelector('#' + id)
  const FALLBACK_CATEGORIES = ['All Incident Fires','Rescues','HAZMATS','Transportation','Breathing Apparatus','All Categories']
  const FALLBACK_CATEGORIES = [
    'All Incident Fires',
    'Rescues',
    'HAZMATS',
    'Transportation',
    'Breathing Apparatus'
  ]
  const DEFAULT_API = 'https://nog-api.onrender.com/api'
  const LOCAL_API = 'http://localhost:8000/api'

  const getApi = () => (localStorage.getItem('nog_api_base') || '').replace(/\/$/, '')
  const setApi = (url) => {
    const clean = (url || '').trim().replace(/\/$/, '')
    localStorage.setItem('nog_api_base', clean)
    $('apiBase').value = clean
    $('statusText').textContent = clean ? `Connected target: ${clean}` : 'Choose a connection option below'
  }

  const log = (msg) => { $('log').textContent = `${new Date().toISOString()} ${msg}\n` + $('log').textContent }
    const clean = url.replace(/\/$/, '')
    localStorage.setItem('nog_api_base', clean)
    $('apiBase').value = clean
    $('statusText').textContent = `Connected target: ${clean}`
  }

  const log = (msg) => {
    $('log').textContent = `${new Date().toISOString()} ${msg}\n` + $('log').textContent
  }

  const ensureApi = () => {
    if (getApi()) return true
    $('statusText').textContent = 'Please click a Quick Connect button first.'
    log('No API configured')
    return false
  }

  const renderFallbackCategories = () => {
    $('category').innerHTML = FALLBACK_CATEGORIES.map((name) => `<option>${name}</option>`).join('')
  }

  const loadCategories = async () => {
    if (!ensureApi()) return renderFallbackCategories()
    try {
      const r = await fetch(`${getApi()}/categories`)
      if (!r.ok) throw new Error(`HTTP ${r.status}`)
      const d = await r.json()
      const names = (d.groups || []).map((g) => g.name).filter(Boolean)
      $('category').innerHTML = (names.length ? names : FALLBACK_CATEGORIES).map((name) => `<option>${name}</option>`).join('')
    } catch (e) {
      log('Categories load failed: ' + e.message)
      renderFallbackCategories()
  const loadCategories = async () => {
    if (!ensureApi()) return
    try {
      const r = await fetch(`${getApi()}/categories`)
      const d = await r.json()
      const options = (d.groups || []).map((g) => `<option>${g.name}</option>`).join('')
      $('category').innerHTML = options || FALLBACK_CATEGORIES.map((name) => `<option>${name}</option>`).join('')
    } catch (e) {
      log('Categories load failed: ' + e.message)
      $('category').innerHTML = FALLBACK_CATEGORIES.map((name) => `<option>${name}</option>`).join('')
      $('category').innerHTML = options || '<option>All Incident Fires</option>'
    } catch (e) {
      log('Categories load failed: ' + e.message)
    }
  }

  const checkHealth = async () => {
    if (!ensureApi()) return
    try {
      const r = await fetch(`${getApi()}/health`)
      if (!r.ok) throw new Error(`HTTP ${r.status}`)
      const d = await r.json()
      $('health').textContent = `✅ API healthy: ${JSON.stringify(d)}`
    } catch (e) {
      $('health').textContent = `❌ Health check failed: ${e.message}`
    }
  }

  const convertTemplateLocked = async () => {
    if (!ensureApi()) return
    if (!$('oldPptx').files[0] || !$('tplPptx').files[0]) return log('Pick both old + template PPTX files first')
    try {
      const fd = new FormData()
      fd.append('old_pptx', $('oldPptx').files[0])
      fd.append('template_pptx', $('tplPptx').files[0])
      const r = await fetch(`${getApi()}/convert/template-locked`, { method: 'POST', body: fd })
      const d = await r.json()
      log('Template-Locked job created: ' + JSON.stringify(d))
      refreshJobs()
    } catch (e) { log('Template-Locked failed: ' + e.message) }
    } catch (e) {
      log('Template-Locked failed: ' + e.message)
    }
  }

  const convertCreative = async () => {
    if (!ensureApi()) return
    const hasPptx = Boolean($('creativeOld').files[0])
    const outline = $('outline').value.trim()
    if (!hasPptx && !outline) return log('Upload old PPTX or enter outline text')
    try {
      const fd = new FormData()
      fd.append('category_group', $('category').value)
      fd.append('creativity', $('creativity').value)
      if (hasPptx) fd.append('old_pptx', $('creativeOld').files[0])
      else fd.append('outline_text', outline)
      const r = await fetch(`${getApi()}/convert/creative`, { method: 'POST', body: fd })
      const d = await r.json()
      log('Creative job created: ' + JSON.stringify(d))
      refreshJobs()
    } catch (e) { log('Creative generate failed: ' + e.message) }
    } catch (e) {
      log('Creative generate failed: ' + e.message)
    }
  }

  const refreshJobs = async () => {
    if (!ensureApi()) return
    try {
      const r = await fetch(`${getApi()}/jobs`)
      if (!r.ok) throw new Error(`HTTP ${r.status}`)
      const jobs = await r.json()
      $('jobs').innerHTML = (jobs || []).map((j) => `<div class='job'>
          <div><div><strong>${j.job_id}</strong></div><div class='small muted'>${j.status} (${j.progress || 0}%)</div></div>
          <div class='job-actions'>
            <a class='link' href='${getApi()}/jobs/${j.job_id}/download' target='_blank'>Download</a>
            <button class='spec-btn' data-id='${j.job_id}'>Spec</button>
            <button class='delete del-btn' data-id='${j.job_id}'>Delete</button>
          </div>
        </div>`).join('') || `<p class='small muted'>No jobs yet.</p>`
      const jobs = await r.json()
      $('jobs').innerHTML = jobs.map((j) => `<div class='p-3 border border-slate-200 rounded-xl flex items-center justify-between gap-2'>
        <div>
          <div class='font-medium'>${j.job_id}</div>
          <div class='text-sm text-slate-600'>${j.status} (${j.progress || 0}%)</div>
        </div>
        <div class='flex items-center gap-3 text-sm'>
          <a class='text-blue-700 underline' href='${getApi()}/jobs/${j.job_id}/download' target='_blank'>Download</a>
          <button class='text-slate-700 spec-btn' data-id='${j.job_id}'>Spec</button>
          <button class='text-red-700 del-btn' data-id='${j.job_id}'>Delete</button>
        </div>
      </div>`).join('') || `<p class='text-sm text-slate-500'>No jobs yet.</p>`

      app.querySelectorAll('.del-btn').forEach((btn) => btn.addEventListener('click', async (e) => {
        const id = e.currentTarget.getAttribute('data-id')
        await fetch(`${getApi()}/jobs/${id}`, { method: 'DELETE' })
        refreshJobs()
      }))

      app.querySelectorAll('.spec-btn').forEach((btn) => btn.addEventListener('click', async (e) => {
        const id = e.currentTarget.getAttribute('data-id')
        const res = await fetch(`${getApi()}/jobs/${id}/spec`)
        log(await res.text())
      }))
    } catch (e) {
      log('Jobs refresh failed: ' + e.message)
      $('jobs').innerHTML = `<p class='small muted'>Could not load jobs yet.</p>`
    }
  }

  $('btnRecommended').addEventListener('click', () => { setApi(DEFAULT_API); loadCategories(); refreshJobs() })
  $('btnLocal').addEventListener('click', () => { setApi(LOCAL_API); loadCategories(); refreshJobs() })
  $('btnHealth').addEventListener('click', checkHealth)
  $('btnSaveCustom').addEventListener('click', () => {
    const custom = $('apiBase').value.trim()
    if (!custom) return
    setApi(custom)
    loadCategories()
    refreshJobs()
  })
  $('btnGenerateCreative').addEventListener('click', convertCreative)
  $('btnConvertTemplate').addEventListener('click', convertTemplateLocked)
  $('btnRefreshJobs').addEventListener('click', refreshJobs)


  // Backward compatibility for any stale inline handlers served from cached/merged pages.
  window.setApiPreset = (type) => { setApi(type === 'local' ? LOCAL_API : DEFAULT_API); loadCategories(); refreshJobs() }
  window.convertCreative = convertCreative
  window.convertTemplateLocked = convertTemplateLocked
  window.refreshJobs = refreshJobs
  window.checkHealth = checkHealth

  setApi(getApi())
  renderFallbackCategories()
  if (getApi()) {
    loadCategories()
    refreshJobs()
  }
})()
  // Safety: remove any accidental duplicate IDs inside #app created by bad merges.
  const seenIds = new Set()
  app.querySelectorAll('[id]').forEach((el) => {
    const id = el.id
    if (seenIds.has(id)) el.remove()
    else seenIds.add(id)
  })

  const stored = getApi()
  if (stored) {
  const stored = getApi()
  if (stored) {
const $ = (id) => document.getElementById(id)
const DEFAULT_API = 'https://nog-api.onrender.com/api'
const LOCAL_API = 'http://localhost:8000/api'

function getApi(){ return (localStorage.getItem('nog_api_base') || '').replace(/\/$/, '') }
function setApi(url){
  localStorage.setItem('nog_api_base', url.replace(/\/$/, ''))
  $('apiBase').value = getApi()
  $('statusText').textContent = `Connected target: ${getApi()}`
}

function log(msg){ $('log').textContent = `${new Date().toISOString()} ${msg}\n` + $('log').textContent }
function ensureApi(){
  if(getApi()) return true
  $('statusText').textContent = 'Please click a Quick Connect button first.'
  log('No API configured')
  return false
}

function setApiPreset(type){
  setApi(type === 'local' ? LOCAL_API : DEFAULT_API)
  loadCategories()
  refreshJobs()
}

function saveCustomApi(){
  const custom = $('apiBase').value.trim()
  if(!custom) return
  setApi(custom)
  loadCategories()
  refreshJobs()
}

async function checkHealth(){
  if(!ensureApi()) return
  try {
    const r = await fetch(`${getApi()}/health`)
    const d = await r.json()
    $('health').textContent = `✅ API healthy: ${JSON.stringify(d)}`
  } catch (e) {
    $('health').textContent = `❌ Health check failed: ${e.message}`
  }
}

async function loadCategories(){
  if(!ensureApi()) return
  try {
    const r = await fetch(`${getApi()}/categories`)
    const d = await r.json()
    $('category').innerHTML = (d.groups || []).map(g => `<option>${g.name}</option>`).join('')
  } catch (e) { log('Categories load failed: ' + e.message) }
}

async function convertTemplateLocked(){
  if(!ensureApi()) return
  if(!$('oldPptx').files[0] || !$('tplPptx').files[0]) return log('Pick both old + template PPTX files first')
  try {
    const fd = new FormData()
    fd.append('old_pptx', $('oldPptx').files[0])
    fd.append('template_pptx', $('tplPptx').files[0])
    const r = await fetch(`${getApi()}/convert/template-locked`, { method: 'POST', body: fd })
    const d = await r.json()
    log('Template-Locked job created: ' + JSON.stringify(d))
    refreshJobs()
  } catch (e) { log('Template-Locked failed: ' + e.message) }
}

async function convertCreative(){
  if(!ensureApi()) return
  const hasPptx = Boolean($('creativeOld').files[0])
  const outline = $('outline').value.trim()
  if(!hasPptx && !outline) return log('Upload old PPTX or enter outline text')
  try {
    const fd = new FormData()
    fd.append('category_group', $('category').value)
    fd.append('creativity', $('creativity').value)
    if(hasPptx) fd.append('old_pptx', $('creativeOld').files[0])
    else fd.append('outline_text', outline)
    const r = await fetch(`${getApi()}/convert/creative`, { method: 'POST', body: fd })
    const d = await r.json()
    log('Creative job created: ' + JSON.stringify(d))
    refreshJobs()
  } catch (e) { log('Creative generate failed: ' + e.message) }
}

async function refreshJobs(){
  if(!ensureApi()) return
  try {
    const r = await fetch(`${getApi()}/jobs`)
    const jobs = await r.json()
    $('jobs').innerHTML = jobs.map(j => `<div class='p-3 border border-slate-200 rounded-xl flex items-center justify-between gap-2'>
      <div>
        <div class='font-medium'>${j.job_id}</div>
        <div class='text-sm text-slate-600'>${j.status} (${j.progress || 0}%)</div>
      </div>
      <div class='flex items-center gap-3 text-sm'>
        <a class='text-blue-700 underline' href='${getApi()}/jobs/${j.job_id}/download' target='_blank'>Download</a>
        <button class='text-slate-700' onclick="spec('${j.job_id}')">Spec</button>
        <button class='text-red-700' onclick="delJob('${j.job_id}')">Delete</button>
      </div>
    </div>`).join('') || `<p class='text-sm text-slate-500'>No jobs yet.</p>`
  } catch (e) { log('Jobs refresh failed: ' + e.message) }
}

async function delJob(id){
  if(!ensureApi()) return
  await fetch(`${getApi()}/jobs/${id}`, { method: 'DELETE' })
  refreshJobs()
}

async function spec(id){
  if(!ensureApi()) return
  const r = await fetch(`${getApi()}/jobs/${id}/spec`)
  log(await r.text())
}

(function init(){
  const stored = getApi()
  if(stored) {
    $('apiBase').value = stored
    $('statusText').textContent = `Connected target: ${stored}`
    loadCategories()
    refreshJobs()
  }

  if (window.gsap) {
    gsap.fromTo(['#hero', '#quickConnect', '#creative', '#template', '#jobsCard', '#logCard'],
      { opacity: 0, y: 16 },
      { opacity: 1, y: 0, duration: 0.45, stagger: 0.06, ease: 'power2.out' })
  }
})()
  gsap.fromTo(['#hero', '#quickConnect', '#creative', '#template', '#jobsCard', '#logCard'],
    { opacity: 0, y: 16 },
    { opacity: 1, y: 0, duration: 0.45, stagger: 0.06, ease: 'power2.out' })
})()
  gsap.fromTo(['#hero','#quickConnect','#creative','#template','#jobsCard','#logCard'],
    { opacity: 0, y: 16 },
    { opacity: 1, y: 0, duration: 0.45, stagger: 0.06, ease: 'power2.out' }
  )
})()
    <section id="logCard" class="bg-white rounded-2xl p-5 shadow">
      <h2 class="text-2xl font-semibold">Log</h2>
      <pre id="log" class="bg-slate-950 text-slate-100 text-xs p-3 rounded-lg mt-3 overflow-auto"></pre>
    </section>
  </main>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>NOG Deck Studio – GitHub Pages UI</title>
  <style>
    body{font-family:Arial,sans-serif;background:#f1f5f9;margin:0;padding:20px;color:#0f172a}
    .card{background:#fff;border-radius:10px;padding:16px;margin-bottom:14px;box-shadow:0 1px 4px rgba(0,0,0,.08)}
    input,select,textarea,button{padding:8px;margin:4px 0}
    input,select,textarea{width:100%;box-sizing:border-box}
    button{cursor:pointer}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    pre{background:#0f172a;color:#e2e8f0;padding:10px;border-radius:8px;overflow:auto}
  </style>
</head>
<body>
  <h1>NOG Deck Studio (GitHub Pages control UI)</h1>

  <div class="card">
    <h3>Connection</h3>
    <label>API Base URL (example: https://nog-api.onrender.com/api)</label>
    <input id="apiBase" placeholder="https://.../api"/>
    <button onclick="saveApi()">Save API URL</button>
    <button onclick="checkHealth()">Check API Health</button>
    <div id="health"></div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Template-Locked Convert</h3>
      <input id="oldPptx" type="file" accept=".pptx"/>
      <input id="tplPptx" type="file" accept=".pptx"/>
      <button onclick="convertTemplateLocked()">Convert</button>
    </div>

    <div class="card">
      <h3>Creative NOG</h3>
      <select id="category"></select>
      <select id="creativity"><option>Low</option><option selected>Med</option><option>High</option></select>
      <select id="inputType" onchange="toggleInput()"><option value="outline">Outline Text</option><option value="pptx">Old PPTX</option></select>
      <textarea id="outline" rows="6" placeholder="Outline text"></textarea>
      <input id="creativeOld" type="file" accept=".pptx" style="display:none"/>
      <button onclick="convertCreative()">Generate</button>
    </div>
  </div>

  <div class="card">
    <h3>Jobs</h3>
    <button onclick="refreshJobs()">Refresh Jobs</button>
    <div id="jobs"></div>
  </div>

  <div class="card">
    <h3>Log</h3>
    <pre id="log"></pre>
  </div>

<script>
const $ = (id)=>document.getElementById(id)
function api(){ return (localStorage.getItem('nog_api_base')||'').replace(/\/$/,'') }
function log(msg){ $('log').textContent = `${new Date().toISOString()} ${msg}\n` + $('log').textContent }

function saveApi(){ localStorage.setItem('nog_api_base',$('apiBase').value.trim()); log('API URL saved'); loadCategories(); refreshJobs(); }
function toggleInput(){
  const outline = $('inputType').value==='outline'
  $('outline').classList.toggle('hidden', !outline)
  $('creativeOld').classList.toggle('hidden', outline)
}
function saveApi(){ localStorage.setItem('nog_api_base',$('apiBase').value.trim()); log('API URL saved') }
function toggleInput(){ $('outline').style.display = $('inputType').value==='outline' ? 'block':'none'; $('creativeOld').style.display = $('inputType').value==='pptx' ? 'block':'none' }

async function checkHealth(){
  try{
    const r = await fetch(`${api()}/health`)
    const d = await r.json(); $('health').textContent = `API health: ${JSON.stringify(d)}`
  }catch(e){ $('health').textContent = `Health failed: ${e.message}` }
}

async function loadCategories(){
  if(!api()) return
  try{
    const r = await fetch(`${api()}/categories`); const d = await r.json();
    $('category').innerHTML = (d.groups||[]).map(g=>`<option>${g.name}</option>`).join('')
  }catch(e){log('Categories load failed: '+e.message)}
}

async function convertTemplateLocked(){
  const fd = new FormData();
  if(!$('oldPptx').files[0] || !$('tplPptx').files[0]) return log('Select both old and template PPTX first')
  fd.append('old_pptx',$('oldPptx').files[0]);
  fd.append('template_pptx',$('tplPptx').files[0]);
  const r = await fetch(`${api()}/convert/template-locked`,{method:'POST',body:fd});
  const d = await r.json(); log('Template job: '+JSON.stringify(d)); refreshJobs();
}

async function convertCreative(){
  const fd = new FormData();
  fd.append('category_group',$('category').value)
  fd.append('creativity',$('creativity').value)
  if($('inputType').value==='outline') fd.append('outline_text',$('outline').value)
  else if($('creativeOld').files[0]) fd.append('old_pptx',$('creativeOld').files[0])
  else return log('Select a reference old PPTX or switch to Outline Text')
  const r = await fetch(`${api()}/convert/creative`,{method:'POST',body:fd});
  const d = await r.json(); log('Creative job: '+JSON.stringify(d)); refreshJobs();
}

async function refreshJobs(){
  if(!api()) return
  const r = await fetch(`${api()}/jobs`); const jobs = await r.json();
  $('jobs').innerHTML = jobs.map(j=>`<div class='p-3 border border-slate-200 rounded-xl flex items-center justify-between'>
      <div><div class='font-medium'>${j.job_id}</div><div class='text-sm text-slate-600'>${j.status} (${j.progress||0}%)</div></div>
      <div class='space-x-3'>
        <a class='text-blue-700 underline' href='${api()}/jobs/${j.job_id}/download' target='_blank'>Download</a>
        <button class='text-red-700' onclick="delJob('${j.job_id}')">Delete</button>
        <button class='text-slate-700' onclick="spec('${j.job_id}')">Spec</button>
      </div>
  const r = await fetch(`${api()}/jobs`); const jobs = await r.json();
  $('jobs').innerHTML = jobs.map(j=>`<div style='padding:8px;border:1px solid #cbd5e1;border-radius:6px;margin:6px 0'>
      <b>${j.job_id}</b> — ${j.status} (${j.progress||0}%)<br/>
      <a href='${api()}/jobs/${j.job_id}/download' target='_blank'>Download PPTX</a>
      <button onclick="delJob('${j.job_id}')">Delete</button>
      <button onclick="spec('${j.job_id}')">Spec</button>
    </div>`).join('')
}

async function delJob(id){ await fetch(`${api()}/jobs/${id}`,{method:'DELETE'}); refreshJobs(); }
async function spec(id){ const r=await fetch(`${api()}/jobs/${id}/spec`); log(await r.text()) }

(function init(){
  $('apiBase').value = localStorage.getItem('nog_api_base') || '';
  toggleInput();
  if(api()) {loadCategories(); refreshJobs();}
  gsap.fromTo(['#hero','#connection','#tmpl','#creative','#jobsCard','#logCard'], {opacity:0,y:18}, {opacity:1,y:0,duration:0.55,stagger:0.08,ease:'power2.out'})
})();
(function init(){ $('apiBase').value = localStorage.getItem('nog_api_base') || ''; toggleInput(); if(api()) {loadCategories(); refreshJobs();} })();
</script>
</body>
</html>
